
<script>
/*
  Versión final CITEN ⚑
  - Banner azul marino institucional (#002855)
  - Ícono de bandera ⚑
  - Indica rango o cantidad + modo (Secuencial/Aleatorio)
  - Muestra número original del banco [#N]
*/

const RUTA_JSON = "preguntas.json";
let preguntasAll = [];
let preguntasActivas = [];
let respuestasUsuario = [];
let indicesOriginales = [];
let subtituloActual = "";

async function cargarPreguntas() {
  try {
    const resp = await fetch(RUTA_JSON);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if (!Array.isArray(data)) throw new Error('Formato inválido: se esperaba un array');
    preguntasAll = data;
  } catch (err) {
    alert("Error al cargar preguntas.json: " + err.message);
  }
}

function mezclarArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function mostrarError(text) {
  const box = document.getElementById('errorBox');
  if (!text) {
    box.style.display = 'none';
    box.textContent = '';
  } else {
    box.style.display = 'block';
    box.textContent = text;
  }
}

function crearVista() {
  const cont = document.getElementById("main");
  cont.innerHTML = "";

  // ⚑ Banner azul marino institucional CITEN
  if (subtituloActual) {
    const banner = document.createElement("div");
    banner.style.background = "#002855";
    banner.style.color = "white";
    banner.style.fontWeight = "600";
    banner.style.padding = "10px 14px";
    banner.style.borderRadius = "8px";
    banner.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
    banner.style.marginBottom = "14px";
    banner.style.display = "flex";
    banner.style.alignItems = "center";
    banner.style.gap = "10px";

    const icono = document.createElement("span");
    icono.textContent = "⚑";
    icono.style.fontSize = "1.4rem";
    icono.style.lineHeight = "1";
    icono.style.display = "flex";
    icono.style.alignItems = "center";

    const texto = document.createElement("span");
    texto.textContent = subtituloActual;

    banner.appendChild(icono);
    banner.appendChild(texto);
    cont.appendChild(banner);
  }

  respuestasUsuario = Array(preguntasActivas.length).fill(null);
  updateProgreso();

  preguntasActivas.forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "pregunta";
    const titulo = document.createElement("h3");
    titulo.textContent = `${idx + 1}. [#${indicesOriginales[idx]}] ${p.pregunta}`;
    card.appendChild(titulo);

    p.opciones.forEach((opt, i) => {
      const label = document.createElement("label");
      label.className = "opcion";
      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = "pregunta_" + idx;
      radio.value = i;
      radio.onclick = () => onResponder(idx, i, card);
      label.appendChild(radio);
      label.appendChild(document.createTextNode(" " + opt));
      card.appendChild(label);
    });
    cont.appendChild(card);
  });
}

function onResponder(idx, idxSel, card) {
  const p = preguntasActivas[idx];
  const esCorrecta = idxSel === p.correcta;
  respuestasUsuario[idx] = { seleccion: idxSel, correcta: esCorrecta };

  const labels = card.querySelectorAll(".opcion");
  labels.forEach(l => l.classList.add("disabled"));

  const feedback = document.createElement("div");
  feedback.className = "feedback " + (esCorrecta ? "ok" : "bad");
  feedback.textContent = esCorrecta
    ? "✅ ¡Correcto!"
    : "❌ Incorrecto. Respuesta correcta: " + p.opciones[p.correcta];
  card.appendChild(feedback);

  labels.forEach((lab, i) => {
    if (i === p.correcta) lab.style.background = "#e8f5e9";
    if (i === idxSel && !esCorrecta) lab.style.background = "#ffebee";
  });

  updateProgreso();
  if (respuestasUsuario.every(r => r !== null)) mostrarResultado();
}

function updateProgreso() {
  const total = preguntasActivas.length;
  const respondidas = respuestasUsuario.filter(r => r !== null).length;
  const pct = total ? Math.round((respondidas / total) * 100) : 0;
  document.getElementById("barraProgreso").style.width = pct + "%";
}

function mostrarResultado() {
  const total = preguntasActivas.length;
  const correctas = respuestasUsuario.filter(r => r && r.correcta).length;
  const porcentaje = ((correctas / total) * 100).toFixed(1);
  const resultado = document.getElementById("resultado");
  resultado.style.display = "block";
  resultado.innerHTML = `
    <strong>Puntaje final:</strong> ${correctas} / ${total} (${porcentaje}%)<br>
    ${porcentaje >= 70 ? "✅ ¡Buen trabajo!" : "📘 Sigue repasando los temas de redes."}
  `;
  document.getElementById("btnReiniciar").style.display = "inline-block";
  document.getElementById("btnIniciar").style.display = "none";
}

function construirSesionDesdeRango(inicio, fin, modo) {
  const total = preguntasAll.length;
  const s = Math.max(1, Math.floor(inicio));
  const f = Math.min(total, Math.floor(fin));
  if (s > f) throw new Error("El número de inicio no puede ser mayor que el número final.");
  const pool = preguntasAll.slice(s - 1, f);
  const indices = Array.from({length: pool.length}, (_, i) => s + i);
  if (modo === 'aleatorio') {
    const combinado = indices.map((idx, i) => ({idx, pregunta: pool[i]}));
    const mezclado = mezclarArray(combinado);
    indicesOriginales = mezclado.map(x => x.idx);
    return mezclado.map(x => x.pregunta);
  } else {
    indicesOriginales = indices;
    return pool.slice();
  }
}

function iniciarSesion() {
  mostrarError(null);
  if (!preguntasAll || preguntasAll.length === 0) {
    mostrarError("No hay preguntas cargadas. Verifica preguntas.json.");
    return;
  }

  const modo = document.querySelector('input[name="mode"]:checked').value;
  const cantidad = parseInt(document.getElementById("cantidadSelect").value, 10);
  const startVal = document.getElementById("startQ").value.trim();
  const endVal = document.getElementById("endQ").value.trim();
  subtituloActual = "";

  if (startVal !== "" || endVal !== "") {
    if (startVal === "" || endVal === "") {
      mostrarError("Si usas rango, completa ambos campos: inicio y fin.");
      return;
    }
    const inicio = Number(startVal);
    const fin = Number(endVal);
    if (!Number.isInteger(inicio) || !Number.isInteger(fin) || inicio < 1 || fin < 1) {
      mostrarError("Los números de inicio y fin deben ser enteros positivos.");
      return;
    }
    if (inicio > fin) {
      mostrarError("El número de inicio no puede ser mayor que el número final.");
      return;
    }
    if (inicio > preguntasAll.length || fin > preguntasAll.length) {
      mostrarError(`Rango fuera de límites. El banco tiene ${preguntasAll.length} preguntas.`);
      return;
    }
    preguntasActivas = construirSesionDesdeRango(inicio, fin, modo);
    subtituloActual = `Preguntas del banco: ${inicio} – ${fin}  (modo: ${modo.charAt(0).toUpperCase() + modo.slice(1)})`;
  } else {
    if (!Number.isInteger(cantidad) || cantidad < 1) {
      mostrarError("Selecciona una cantidad válida (10, 20, 50).");
      return;
    }
    let pool = preguntasAll.map((p, i) => ({p, idx: i + 1}));
    if (modo === 'aleatorio') pool = mezclarArray(pool);
    const subset = pool.slice(0, Math.min(cantidad, pool.length));
    preguntasActivas = subset.map(x => x.p);
    indicesOriginales = subset.map(x => x.idx);
    subtituloActual = `Mostrando ${preguntasActivas.length} preguntas  (modo: ${modo.charAt(0).toUpperCase() + modo.slice(1)})`;
  }

  if (!preguntasActivas || preguntasActivas.length === 0) {
    mostrarError("No se seleccionaron preguntas para la sesión. Ajusta la cantidad o el rango.");
    return;
  }

  document.getElementById("resultado").style.display = "none";
  crearVista();
  document.getElementById("btnIniciar").style.display = "none";
  document.getElementById("btnReiniciar").style.display = "inline-block";
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function reiniciar() {
  preguntasActivas = [];
  respuestasUsuario = [];
  indicesOriginales = [];
  subtituloActual = "";
  document.getElementById("main").innerHTML = "";
  document.getElementById("resultado").style.display = "none";
  document.getElementById("btnReiniciar").style.display = "none";
  document.getElementById("btnIniciar").style.display = "inline-block";
  document.getElementById("barraProgreso").style.width = "0%";
  mostrarError(null);
}

document.getElementById("btnIniciar").addEventListener("click", iniciarSesion);
document.getElementById("btnReiniciar").addEventListener("click", reiniciar);
window.addEventListener("DOMContentLoaded", async () => { await cargarPreguntas(); });
</script>
